#!/usr/bin/env python
import sys
import fortran
import tornado.template

#conditional = {
#    'alk':  ('#ifdef ALLOW_CARBON\n', '\n#endif'),
#    'o2':   ('#ifdef ALLOW_CARBON\n', '\n#endif'),
#    'cdom': ('#ifdef ALLOW_CDOM\n', '\n#endif'),
#}

warning = '''
C!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
C!!!!!!!!!!!!!! AUTOGENERATED FILE -- WILL BE OVERWRITTEN !!!!!!!!!!!!!!
C!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
'''.strip()

p,conds = fortran.readparameters('GUD_SIZE.h', 'GUD_INDICES.h', conditions=True)
conditional = {}
for k,v in conds.items():
    v = [c for c in v if not c.endswith('ALLOW_GUD\n')]
    if k[0] == 'i' and len(v):
        conditional[k[1:]] = (''.join(v), len(v)*'#endif\n')

flds = []
lflds = []
for k in p:
    if k[0] == 'i' and k[1:4] not in ['Min', 'Max']:
        name = k[1:]
        pre,suf = conditional.get(name.lower(), ('', ''))
        if 'e'+name in p:
            lflds.append((name, '{:<5s}'.format(name), pre, suf))
        else:
            flds.append((name, '{:<6s}'.format(name), pre, suf))

loader = tornado.template.Loader('.')

targets = sys.argv[1:]
for tgt in targets:
    tmpl = loader.load(tgt+'.template')
    with open(tgt, 'w') as f:
        f.write(tmpl.generate(flds=flds, lflds=lflds, EDIT_THIS_FILE=warning))

